<html>
    <head>
        <style>
            table {
                border: 1px solid black;
            }

            th {
                text-align: left;
                padding-right: 15px;
            }

            tr.top th {
                text-align: center;
            }

            td.time {
            }

            td.time.won {
                border: 2px solid #30FF70;
            }

            td.time.lost {
                border: 2px solid #FF0000;
            }

            td a {
                padding-right: 6px;
            }

            tr.even {
                background: #f0f0f0;
            }

            tr.odd {
                background: #d0d0d0;
            }

            tr.specs td {
                padding: 10px;
            }
        </style>
    </head>

    <body>


<h1>Test-Stream OO internals optimization metrics</h1>

<h2>Why does this matter?</h2>

This topic first came up here:
<a href="https://rt.perl.org/Public/Bug/Display.html?id=122538#txn-1304852">perlbug #122538</a>
when it was noticed that the new development on Test-Simple resulted in ~300%
increase in cpu usage running tests. This was bad on any machine, but had the
most noticable effect on older systems and architectures that p5p is still
commited to supporting.

<p>

The two biggest performance drains found by profiling were the stack-tracign
debugging code, and the time spent in object method calls.

<p>

The biggest cause of performance issues was the design decision to do a
complete stack trace every time an event was triggered. This decision was made
to improve error reporting and debugging. This design decision was scrapped in
favor of the context model, which provided most of the same benfit, witohut the
huge performance loss.
<dl>
    <dt>Trace Model (scrapped)</dt>
    <dd>
        <a href="https://github.com/Test-More/test-more/blob/6eaa457e8fe673906d0e24146827c6f6e9785d77/lib/Test/Builder/Trace.pm#L45">Test::Builder::Trace</a>
    </dd>
    <dt>Context Model (Current)</dt>
    <dd>
        <a href="https://github.com/Test-More/test-more/blob/master/lib/Test/Stream/Context.pm">Test::Stream::Context</a>
    </dd>
</dl>

<p>

According to profiling, the second biggest place time was spent was on OOP. I
ultimately settled on a system that uses array based objects with constants for
directly accessing the correct index when writing code internal to an object.
Methods are generated for use by code outside the module itself.

<p>

I worked on solving both problems at once, I did this to avoid writing the
entire thing with one object system then needing to adapt it. Unfortunately
this resulted in no intermediate profilable steps with numbers I could provide.
It also meant it was not possible to tell what performance was gained by the
object system changes vs the other changes. I did use profiling to tune things
as I went, but this was done on test scripts, and I no longer have the data
used to validate my decisions. <b>I realize this is bad.</b>

<p>

Since there has been some question about the Array based design I decided some
hard numbers were needed. What I have done is I have created 3 new branches (in
addition to 'master', and the legacy code in 'stable'). These new branches are
all make use of all the optimizations I have in master, except where noted.
Using these branches it is possible to get both benchmarks and profiling data
for comparing hash based objects and array based objects.

<p>

It is important to note that there are many other optimizations present in
these branches that were not present in my original work. It is possible, maybe
even likely, that these additonal optimizations may reduce the differences made
between these branches. The biggest to note is the change from accessors that
are both getter and setter using shift for $self and copying from @_ for other
arguments to seperate getters/setters that access @_ directly.

<table>
    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/stable">stable</a></th>
        <td>Legacy code, no refactoring.</td>
    </tr>

    <tr class="odd">
        <th><a href="https://github.com/Test-More/test-more/tree/master">master</a></th>
        <td>Test-Stream refactoring. This branch uses arrays as the base for most objects, constants are used to index into the arrays.</td>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const_no_event">hash_with_const_no_event</a></th>
        <td>Test-Stream refactoring. This branch uses arrays as the base for event objects, hashes for all others. Constants are used to index into the hashes and arrays.</td>
    </tr>

    <tr class="odd">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const">hash_with_const</a></th>
        <td>Test-Stream refactoring. This branch uses hashes for nearly all objects. Constants are used to index into the hashes when speed matters.</td>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_no_constants">hash_no_constants</a></th>
        <td>Test-Stream refactoring. This branch uses hashes for all objects, and little if any direct hash access (no constants are generated)</td>
    </tr>
</table>
<p>

<h2>Numbers and Data</ht>

<h3>Profiling</h3>

All profiling done via NYTProf. For each repo we used these scripts:

<dl>
    <dt><a href="https://github.com/Test-More/test-more/blob/master/profiling/compile.pl">compile.pl</a></dt>
    <dd>This one simply loads Test::Builder, produces a single result, then exits properly.</dd>
    <dt><a href="https://github.com/Test-More/test-more/blob/master/profiling/long-run.pl">long-run.pl</a></dt>
    <dd>This one runs a gauntlet of tests in a loop to generate many events</dd>
</dl>

Profiling was one on 2 systems, one very modern, and an emulated system
intended to represent the many slow machines people have to work with every
day. The slow machine factor is very important to many people who maintain perl
itself, and it would be wrong to ignore it.

<table class="machines">
    <tr class="specs">
        <td>
            <pre>
Intel core I7-2670QM 2.20ghz, 12GB ram, SSD drive
Ubuntu server 14.10 (amd64), fresh install
perl-5.20.2 installed via perlbrew
            </pre>
        </td>
        <td>
            <pre>
Emulated Pentium MMX, 256mb ram, Image stored on an SSD drive
Ubuntu server 14.10 (i386), fresh install
perl-5.20.2 installed via perlbrew
            </pre>
        </td>
    </tr>
    <tr>
        <td>
            <table>
                <tr class="top">
                    <th>Branch</th>
                    <th>Compile</th>
                    <th>Long Run</th>
                </tr>

                <tr class="even">
                    <th><a href="https://github.com/Test-More/test-more/tree/stable">stable</a></th>
                    <td><a href="nytprof-stable-start/index.html">58.8ms</a></td>
                    <td><a href="nytprof-stable-long/index.html">36.1s</a></td>
                </tr>

                <tr class="odd">
                    <th><a href="https://github.com/Test-More/test-more/tree/master">master</a></th>
                    <td><a href="nytprof-master-start/index.html">116ms</a></td>
                    <td><a href="nytprof-master-long/index.html">31.3s</a></td>
                </tr>

                <tr class="even">
                    <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const_no_event">hash_with_const_no_event</a></th>
                    <td><a href="nytprof-hwcne-start/index.html">108ms</a></td>
                    <td><a href="nytprof-hwcne-long/index.html">32.7s</a></td>
                </tr>

                <tr class="odd">
                    <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const">hash_with_const</a></th>
                    <td><a href="nytprof-hwc-start/index.html">117ms</a></td>
                    <td><a href="nytprof-hwc-long/index.html">37.4s</a></td>
                </tr>

                <tr class="even">
                    <th><a href="https://github.com/Test-More/test-more/tree/hash_no_constants">hash_no_constants</a></th>
                    <td><a href="nytprof-hnc-start/index.html">113ms</a></td>
                    <td><a href="nytprof-hnc-long/index.html">47.6s</a></td>
                </tr>
            </table>
        </td>
        <td>
            <table>
                <tr class="top">
                    <th>Branch</th>
                    <th>Compile</th>
                    <th>Long Run</th>
                </tr>

                <tr class="even">
                    <th><a href="https://github.com/Test-More/test-more/tree/stable">stable</a></th>
                    <td><a href="slow-stable-start/index.html">362ms</a></td>
                    <td><a href="slow-stable-long/index.html">11m51s</a></td>
                </tr>

                <tr class="odd">
                    <th><a href="https://github.com/Test-More/test-more/tree/master">master</a></th>
                    <td><a href="slow-master-start/index.html">1.12s</a></td>
                    <td><a href="slow-master-long/index.html">12m50s</a></td>
                </tr>

                <tr class="even">
                    <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const_no_event">hash_with_const_no_event</a></th>
                    <td><a href="slow-hcne-start/index.html">829ms</a></td>
                    <td><a href="slow-hcne-long/index.html">10m55s</a></td>
                </tr>

                <tr class="odd">
                    <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const">hash_with_const</a></th>
                    <td><a href="slow-hc-start/index.html">935ms</a></td>
                    <td><a href="slow-hc-long/index.html">12m09s</a></td>
                </tr>

                <tr class="even">
                    <th><a href="https://github.com/Test-More/test-more/tree/hash_no_constants">hash_no_constants</a></th>
                    <td><a href="slow-hnc-start/index.html">836ms</a></td>
                    <td><a href="slow-hnc-long/index.html">14m52s</a></td>
                </tr>
            </table>
        </td>
    </tr>
</table>

        <p>

<h3>Benchmarks</h3>

These are the benchmarks for building perl blead.

<table class="machines">
    <tr class="specs">
        <td>
            <pre>
Intel core I7-2670QM 2.20ghz, 12GB ram, SSD drive
Ubuntu server 14.10 (amd64), fresh install
Parent Commit: 8593d8e7bf09e8da95a3fb5cce4041e0577208a6
            </pre>
        </td>
        <td>
            <pre>
Emulated Pentium MMX, 256mb ram, Image stored on an SSD drive
Ubuntu server 14.10 (i386), fresh install
Parent Commit: 813d2eb17164751c312a69e7c7c56dc71aad1ff1
            </pre>
        </td>
    </tr>
    <tr>
        <td>
<table>
    <tr id="top">
        <th>Branch</th>
        <th>Results</th>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/stable">stable</a></th>
        <td class="time">
<pre>
</pre>
        </td>
    </tr>

    <tr class="odd">
        <th><a href="https://github.com/Test-More/test-more/tree/master">master</a></th>
        <td class="time">
            <pre>13m38s: 53.49 usr 6.88 sys + 437.52 cusr 44.32 csys = 542.21 CPU</pre>
        </td>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const_no_event">hash_with_const_no_event</a></th>
        <td class="time">
            <pre>13m59s: 53.75 usr 6.94 sys + 450.69 cusr 44.67 csys = 556.05 CPU</pre>
        </td>
    </tr>

    <tr class="odd">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const">hash_with_const</a></th>
        <td class="time">
            <pre>13m45s: 54.31 usr 6.90 sys + 44.21 cusr 44.30 csys = 549.72 CPU</pre>
        </td>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_no_constants">hash_no_constants</a></th>
        <td class="time">
            <pre>13m59s: 53.86 usr 6.70 sys + 451.72 cusr 44.50 csys = 556.70 CPU</pre>
        </td>
    </tr>
</table>
        </td>
        <td>
<table>
    <tr id="top">
        <th>Branch</th>
        <th>Results</th>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/stable">stable</a></th>
        <td class="time">
<pre>
</pre>
        </td>
    </tr>

    <tr class="odd">
        <th><a href="https://github.com/Test-More/test-more/tree/master">master</a></th>
        <td class="time">
            <pre>1h52m28s: 825.30 usr 68.24 sys + 5037.28 cusr 361.81 csys = 6292.63 CPU</pre>
        </td>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const_no_event">hash_with_const_no_event</a></th>
        <td class="time">
            <pre>1h53m19s: 856.83 usr 68.38 sys + 5051.50 cusr 363.55 csys = 6340.26 CPU</pre>
        </td>
    </tr>

    <tr class="odd">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_with_const">hash_with_const</a></th>
        <td class="time">
            <pre>2h00m26s: 793.38 usr 68.75 sys + 5526.94 cusr 379.85 csys = 6768.92 CPU</pre>
        </td>
    </tr>

    <tr class="even">
        <th><a href="https://github.com/Test-More/test-more/tree/hash_no_constants">hash_no_constants</a></th>
        <td class="time">
<pre>
</pre>
        </td>
    </tr>
</table>
        </td>
    </tr>
    </body>
</html>
